<!DOCTYPE html>
<html>
<head>
    <title>ã‚µãƒ³ã‚µãƒ³ã‚­ãƒƒã‚ºTV å°æœ¬æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>ğŸ¬ ã‚µãƒ³ã‚µãƒ³ã‚­ãƒƒã‚ºTV å°æœ¬æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="flex: 1;">
            <div style="margin-bottom: 10px;">
                <label>ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š</label>
                <input type="text" id="keyword" placeholder="ä¾‹: ã‚µãƒ³ã‚µãƒ³ã€ãã‚‚ã‚Šã‚“" style="width: 300px; margin-right: 10px;">
                <button onclick="performSearch()">æ¤œç´¢å®Ÿè¡Œ</button>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center; font-size: 14px;">
                <div>
                    <label>ä»¶æ•°ï¼š</label>
                    <select id="limitResults" style="padding: 4px;">
                        <option value="20">20ä»¶</option>
                        <option value="50" selected>50ä»¶</option>
                        <option value="100">100ä»¶</option>
                        <option value="200">200ä»¶</option>
                        <option value="500">500ä»¶</option>
                        <option value="1000">1000ä»¶</option>
                    </select>
                </div>
            </div>
        </div>
        <button onclick="logout()" style="background: #dc3545; color: white; padding: 8px 12px; font-size: 14px; border: none; border-radius: 5px; cursor: pointer;">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    
    <div id="loading" style="display: none;">
        <p>ğŸ”„ æ¤œç´¢ä¸­...</p>
    </div>
    
    <div id="results" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <h3 id="resultsHeader" style="margin: 0;"></h3>
            <div style="display: flex; gap: 15px; align-items: center; font-size: 14px;">
                <div>
                    <label>çµã‚Šè¾¼ã¿ï¼š</label>
                    <select id="contentFilter" style="padding: 4px;" onchange="applyFiltering()">
                        <option value="">ã™ã¹ã¦ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‹ã‚»ãƒªãƒ•ï¼‰</option>
                        <option value="title">å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿</option>
                        <option value="dialogue_only">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚»ãƒªãƒ•ã®ã¿</option>
                    </select>
                </div>
                <div>
                    <label>ä¸¦ã³é †ï¼š</label>
                    <select id="sortOrderPost" style="padding: 4px;" onchange="applySorting()">
                        <option value="management_id_asc">ç®¡ç†ID (æ˜‡é †)</option>
                        <option value="management_id_desc">ç®¡ç†ID (é™é †)</option>
                        <option value="broadcast_date_asc">é…ä¿¡æ—¥ (å¤ã„é †)</option>
                        <option value="broadcast_date_desc">é…ä¿¡æ—¥ (æ–°ã—ã„é †)</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="resultsList"></div>
        <div id="pagination" style="display: none; text-align: center; margin: 20px; padding: 20px;">
            <button id="prevPage" onclick="loadPreviousPage()" style="margin: 0 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">â† å‰ã®ãƒšãƒ¼ã‚¸</button>
            <span id="pageInfo" style="margin: 0 20px; font-weight: bold;"></span>
            <button id="nextPage" onclick="loadNextPage()" style="margin: 0 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">æ¬¡ã®ãƒšãƒ¼ã‚¸ â†’</button>
        </div>
    </div>
    
    <div id="error" style="display: none; color: red;"></div>

    <script>
        let currentSearchResults = [];
        let currentKeyword = '';
        let currentPage = 0;
        let currentLimit = 50;
        let currentTotalCount = 0;
        let currentSearchData = null;
        
        async function performSearch(offset = 0) {
            var keyword = document.getElementById('keyword').value.trim();
            var limit = document.getElementById('limitResults').value;
            
            if (!keyword) {
                showError('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            hideError();
            showLoading();
            
            try {
                console.log('æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹:', { keyword, limit, offset });
                
                var response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        character_filter: '',
                        sort_order: 'management_id_asc',
                        limit: parseInt(limit),
                        offset: offset
                    })
                });
                
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                var data = await response.json();
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', data);
                
                if (data.success) {
                    currentSearchResults = data.results;
                    currentKeyword = keyword;
                    currentLimit = parseInt(limit);
                    currentTotalCount = data.total_count || data.count;
                    currentSearchData = data;
                    currentPage = Math.floor(offset / currentLimit);
                    displayResults(data);
                    updatePagination(data);
                } else {
                    showError('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
                
            } catch (error) {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function displayResults(data) {
            var resultsDiv = document.getElementById('results');
            var headerDiv = document.getElementById('resultsHeader');
            var listDiv = document.getElementById('resultsList');
            
            // Improved header with total count and pagination info
            var headerText = 'æ¤œç´¢çµæœ: "' + data.keyword + '" ';
            if (data.total_count !== undefined) {
                headerText += '(å…¨' + data.total_count + 'ä»¶ä¸­ ' + (data.offset + 1) + '-' + (data.offset + data.count) + 'ä»¶ã‚’è¡¨ç¤º)';
                if (data.has_more) {
                    headerText += ' <span style="color: #666; font-size: 12px;">â€»ã•ã‚‰ã«çµæœãŒã‚ã‚Šã¾ã™</span>';
                }
                
                // Add debug info if available for unified structure  
                if (data.debug_info) {
                    headerText += '<br><small style="color: #888;">å†…è¨³: ã‚¿ã‚¤ãƒˆãƒ«' + (data.debug_info.title_matches || 0) + 'ä»¶ + ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚»ãƒªãƒ•' + (data.debug_info.dialogue_matches || 0) + 'ä»¶';
                    if (data.debug_info.instruction_matches_hidden && data.debug_info.instruction_matches_hidden > 0) {
                        headerText += ' (æ’®å½±æŒ‡ç¤º' + data.debug_info.instruction_matches_hidden + 'ä»¶ã¯éè¡¨ç¤º)';
                    }
                    headerText += '</small>';
                }
            } else {
                headerText += '(' + data.count + 'ä»¶)';
            }
            headerDiv.innerHTML = headerText;
            
            var html = '';
            for (var i = 0; i < data.results.length; i++) {
                var result = data.results[i];
                
                // Only display dialogue content - instructions are now hidden
                var borderColor = '#28a745';  // Green for dialogue
                var bgColor = '#f8fff8';      // Light green background
                
                html += '<div style="border: 2px solid ' + borderColor + '; margin: 10px; padding: 10px; background: ' + bgColor + ';">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<h4 style="margin: 0;">' + result.title + ' (' + result.management_id + ')</h4>';
                html += '<span style="background: ' + borderColor + '; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚»ãƒªãƒ•</span>';
                html += '</div>';
                
                // Add year/month info for better categorization
                var dateInfo = result.broadcast_date || 'ãªã—';
                if (result.broadcast_date && result.broadcast_date.length >= 8) {
                    var year = '20' + result.broadcast_date.substring(0, 2);
                    var month = result.broadcast_date.substring(3, 5);
                    dateInfo += ' (' + year + 'å¹´' + month + 'æœˆ)';
                }
                html += '<p><strong>ğŸ“… é…ä¿¡æ—¥:</strong> ' + dateInfo + '</p>';
                if (result.script_url) {
                    html += '<p><strong>ğŸ”— å°æœ¬URL:</strong> <a href="' + result.script_url + '" target="_blank" style="color: #007bff;">ğŸ“‹ å°æœ¬ã‚’é–‹ã</a></p>';
                }
                html += '<p><strong>#ï¸âƒ£ è¡Œç•ªå·:</strong> ' + (result.row_number || 'ãªã—') + '</p>';
                
                // Only display character dialogue (instructions are filtered out by API)
                html += '<div style="background: white; padding: 10px; border-radius: 5px; margin: 10px 0;">';
                html += '<p><strong>ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</strong> <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 3px;">' + (result.character_name || 'ãªã—') + '</span></p>';
                html += '<p><strong>ğŸ’¬ ã‚»ãƒªãƒ•:</strong> <span style="font-weight: normal; line-height: 1.4;">' + (result.dialogue || 'ãªã—') + '</span></p>';
                html += '</div>';
                
                html += '</div>';
            }
            
            listDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showError(message) {
            var errorDiv = document.getElementById('error');
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'block';
            console.error('Error:', message);
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        // èªè¨¼ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        function checkAuth() {
            const auth = sessionStorage.getItem('sunsun_auth');
            const authTime = sessionStorage.getItem('sunsun_auth_time');
            
            if (auth !== 'true' || !authTime) {
                window.location.href = '/index.html';
                return false;
            }
            
            const now = Date.now();
            const authTimestamp = parseInt(authTime);
            const hoursPassed = (now - authTimestamp) / (1000 * 60 * 60);
            
            // 24æ™‚é–“çµŒéã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            if (hoursPassed >= 24) {
                sessionStorage.removeItem('sunsun_auth');
                sessionStorage.removeItem('sunsun_auth_time');
                window.location.href = '/index.html';
                return false;
            }
            
            return true;
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
        function logout() {
            sessionStorage.removeItem('sunsun_auth');
            sessionStorage.removeItem('sunsun_auth_time');
            window.location.href = '/index.html';
        }
        
        // Enterã‚­ãƒ¼ã§æ¤œç´¢
        document.getElementById('keyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // æ¤œç´¢å¾Œã®ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
        function applySorting() {
            var contentFilter = document.getElementById('contentFilter').value;
            var sortOrder = document.getElementById('sortOrderPost').value;
            
            var filteredResults = applyContentFilter(currentSearchResults, contentFilter);
            var sortedResults = sortResults(filteredResults, sortOrder);
            
            displayResultsList(sortedResults);
            updateResultsHeader(sortedResults.length, contentFilter);
        }
        
        // æ¤œç´¢å¾Œã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
        function applyFiltering() {
            var contentFilter = document.getElementById('contentFilter').value;
            var sortOrder = document.getElementById('sortOrderPost').value;
            
            // Determine search type based on filter
            var searchType = 'all';
            if (contentFilter === 'title') {
                searchType = 'title_only';
            } else if (contentFilter === 'dialogue_only') {
                searchType = 'dialogue_only';
            }
            
            // Perform new search with the selected filter
            performSearchWithFilter(searchType, sortOrder);
        }
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyContentFilter(results, contentFilter) {
            if (!contentFilter) return results;
            
            return results.filter(function(result) {
                var keyword = currentKeyword.toLowerCase();
                
                if (contentFilter === 'title') {
                    // ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã®ã¿
                    return result.title && result.title.toLowerCase().includes(keyword);
                } else if (contentFilter === 'dialogue_only') {
                    // çµ±ä¸€æ§‹é€ ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚»ãƒªãƒ•ã®ã¿ã‚’è¡¨ç¤º
                    if (result.content_type === 'dialogue' && result.character_name && result.dialogue) {
                        return (result.dialogue && result.dialogue.toLowerCase().includes(keyword)) ||
                               (result.character_name && result.character_name.toLowerCase().includes(keyword));
                    }
                    return (result.voice_instruction && result.voice_instruction.toLowerCase().includes(keyword)) ||
                           (result.filming_instruction && result.filming_instruction.toLowerCase().includes(keyword));
                }
                
                return true;
            });
        }
        
        // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
        function sortResults(results, sortOrder) {
            var sorted = [...results];
            
            switch(sortOrder) {
                case 'management_id_asc':
                    sorted.sort((a, b) => (a.management_id || '').localeCompare(b.management_id || ''));
                    break;
                case 'management_id_desc':
                    sorted.sort((a, b) => (b.management_id || '').localeCompare(a.management_id || ''));
                    break;
                case 'broadcast_date_asc':
                    sorted.sort((a, b) => (a.broadcast_date || '').localeCompare(b.broadcast_date || ''));
                    break;
                case 'broadcast_date_desc':
                    sorted.sort((a, b) => (b.broadcast_date || '').localeCompare(a.broadcast_date || ''));
                    break;
            }
            
            return sorted;
        }
        
        // çµæœä¸€è¦§ã®è¡¨ç¤º
        function displayResultsList(results) {
            var listDiv = document.getElementById('resultsList');
            
            var html = '';
            for (var i = 0; i < results.length; i++) {
                var result = results[i];
                html += '<div style="border: 1px solid #ccc; margin: 10px; padding: 10px;">';
                html += '<h4>' + result.title + ' (' + result.management_id + ')</h4>';
                html += '<p><strong>é…ä¿¡æ—¥:</strong> ' + (result.broadcast_date || 'ãªã—') + '</p>';
                if (result.script_url) {
                    html += '<p><strong>å°æœ¬URL:</strong> <a href="' + result.script_url + '" target="_blank" style="color: #007bff;">ğŸ“‹ å°æœ¬ã‚’é–‹ã</a></p>';
                }
                html += '<p><strong>è¡Œç•ªå·:</strong> ' + (result.row_number || 'ãªã—') + '</p>';
                html += '<p><strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</strong> ' + (result.character_name || 'ãªã—') + '</p>';
                html += '<p><strong>ã‚»ãƒªãƒ•:</strong> ' + (result.dialogue || 'ãªã—') + '</p>';
                if (result.voice_instruction) {
                    html += '<p><strong>éŸ³å£°æŒ‡ç¤º:</strong> ' + result.voice_instruction + '</p>';
                }
                if (result.filming_instruction) {
                    html += '<p><strong>æ’®å½±æŒ‡ç¤º:</strong> ' + result.filming_instruction + '</p>';
                }
                if (result.editing_instruction) {
                    html += '<p><strong>ç·¨é›†æŒ‡ç¤º:</strong> ' + result.editing_instruction + '</p>';
                }
                html += '</div>';
            }
            
            listDiv.innerHTML = html;
        }
        
        // çµæœãƒ˜ãƒƒãƒ€ãƒ¼ã®æ›´æ–°
        function updateResultsHeader(count, contentFilter) {
            var headerDiv = document.getElementById('resultsHeader');
            var filterInfo = '';
            if (contentFilter === 'title') {
                filterInfo = ' | å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿';
            } else if (contentFilter === 'dialogue_voice_filming') {
                filterInfo = ' | ã‚»ãƒªãƒ•å†…å®¹ã®ã¿';
            } else {
                filterInfo = ' | ã™ã¹ã¦ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‹ã‚»ãƒªãƒ•ï¼‰';
            }
            headerDiv.innerHTML = 'æ¤œç´¢çµæœ: "' + currentKeyword + '" (' + count + 'ä»¶)' + filterInfo;
        }
        
        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
        function updatePagination(data) {
            var paginationDiv = document.getElementById('pagination');
            var prevBtn = document.getElementById('prevPage');
            var nextBtn = document.getElementById('nextPage');
            var pageInfo = document.getElementById('pageInfo');
            
            if (data.total_count && data.total_count > currentLimit) {
                paginationDiv.style.display = 'block';
                
                // Update page info
                pageInfo.innerHTML = 'ãƒšãƒ¼ã‚¸ ' + (currentPage + 1) + ' / ' + Math.ceil(data.total_count / currentLimit);
                
                // Update button states
                prevBtn.disabled = data.offset === 0;
                nextBtn.disabled = !data.has_more;
                
                prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
                nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
            } else {
                paginationDiv.style.display = 'none';
            }
        }
        
        // æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
        function loadNextPage() {
            var nextOffset = (currentPage + 1) * currentLimit;
            performSearch(nextOffset);
        }
        
        // å‰ã®ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
        function loadPreviousPage() {
            var prevOffset = Math.max(0, (currentPage - 1) * currentLimit);
            performSearch(prevOffset);
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä»˜ãæ¤œç´¢
        async function performSearchWithFilter(searchType, sortOrder, offset = 0) {
            var keyword = currentKeyword;
            var limit = currentLimit;
            
            if (!keyword) {
                showError('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            hideError();
            showLoading();
            
            try {
                console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹:', { keyword, searchType, sortOrder, limit, offset });
                
                var response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        character_filter: '',
                        sort_order: sortOrder || 'management_id_asc',
                        limit: limit,
                        offset: offset,
                        search_type: searchType
                    })
                });
                
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                var data = await response.json();
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', data);
                
                if (data.success) {
                    currentSearchResults = data.results;
                    currentSearchData = data;
                    currentPage = Math.floor(offset / currentLimit);
                    displayResults(data);
                    updatePagination(data);
                    
                    // Update filter display
                    var contentFilter = '';
                    if (searchType === 'title_only') contentFilter = 'title';
                    else if (searchType === 'dialogue_only') contentFilter = 'dialogue_voice_filming';
                    updateResultsHeader(data.count, contentFilter);
                } else {
                    showError('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
                
            } catch (error) {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) {
                return;
            }
            log('èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ - ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
        });
    </script>
</body>
</html>